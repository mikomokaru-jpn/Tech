<!-- 
20 DragDrop 
-->
<DOCTYPE HTML>
<html id="mainhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>ドラッグ＆ドロップ</title>
	<link rel="stylesheet" type="text/css" href="/lib/document.css">
</head>
<body id="mainbody">
<!-- ↓↓↓↓↓↓↓↓↓↓↓ -->
<script type="text/javascript" src="/lib/funcs1.js"></script>
<!-- ↑↑↑↑↑↑↑↑↑↑ -->
<div id="content">
<h2 class="lm70 tm20 bm5">ドラッグ＆ドロップ</h2>
<div class="lm70 tm10 rm60">
ビューに表示しているイメージをドラッグ＆ドロップして別のアプルケーションのビューに表示してみる
</div>
<h3 class="lm70 tm10 bm0 rm60">
ドロップの目的地の処理（ドラッグしたイメージを表示する）
</h3>
<div class="lm70 tm0" style="width:550px; border-top:solid 1px #909090;"></div>
<div class="lm70 tm10 rm60">
他のアプリケーションからドラッグしたイメージオブジェクトを本アプリケーションのビューにドロップすると、イメージがビューに表示される。
イメージがURLを持っていたらURLアドレスをテキストビューに表示する。
</div>
<div class="lm70 tm15 rm60">
① イメージエディタ（Grab）に表示されている画像をドラッグし、本アプリのビュー上にドロップして画像を表示する。
</div>
<!-- 画像 -->
<a href="/lib/HTMLofImage.html?filename=/data/20/20_dragDrop10.png&title=ドラッグ＆ドロップ&width=800" target="_new">
<img class="lm80 tm5 bm0" src="20_dragDrop10.png" alt="[ドラッグ＆ドロップ]" width="450"></a>
<div class="lm70 tm15 rm60">
② ブラウザ（Safari）に表示されている画像をドラッグし、本アプリのビュー上にドロップして画像を表示する。URLアドレスをテキストビューに表示する。</div>
<!-- 画像 -->
<a href="/lib/HTMLofImage.html?filename=/data/20/20_dragDrop11.png&title=ドラッグ＆ドロップ&width=800" target="_new">
<img class="lm70 tm5 bm0" src="20_dragDrop11.png" alt="[ドラッグ＆ドロップ]" width="450"></a>
<div class="lm70 tm30 rm60">
③ Finderの画像ファイル名（jpeg, png）をドラッグし、本アプリのビュー上にドロップして画像を表示する。URLアドレスをテキストビューに表示する。
</div>
<!-- 画像 -->
<a href="/lib/HTMLofImage.html?filename=/data/20/20_dragDrop12.png&title=ドラッグ＆ドロップ&width=800" target="_new">
<img class="lm70 tm10 bm0" src="20_dragDrop12.png" alt="[ドラッグ＆ドロップ]" width="450"></a>
<h3 class="lm70 tm30 rm60 bm5">
アプリケーションの実装
</h3>
<div class="lm70 tm5 rm60">
ドラッグ＆ドロップによるオブジェクトの受け渡しは、コピー＆ペーストと同様に、ペーストボードを介して行われる。ペーストボードの種類は、dragingPasteboardオブジェクトである。
</div>
<div class="lm70 tm10 rm60 bm5">
ドロップの目的地の処理は、NSDraggingDestinationプロトコルに準拠しているので、NSViewクラスのサブクラスに実装する。（インタフェース宣言でプロトコルの適用宣言をする必要はない）
</div>
<div class="lm70 tm20 rm60 bm5">
(1) 受け入れオブジェクトの宣言
</div>
<div class="lm70 tm5 rm60">
他のアプリケーションから受け入れ可能なオブジェクトの種類をUTIで指定する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5 bm10" src="/lib/HTMLofText.html?filename=/data/20/D_register.txt" width="580" height="80"></iframe>
<div class="lm70 tm10 rm60 bm5">
(2) デリゲートメソッドの実装
</div>
<div class="lm70 tm5 rm60">
ドラッグ＆ドロップ操作に対するデリゲートメソッドがあらかじめ定義されている。各メソッドをオーバーライドすることにより、ドロップの目的地の処理を実装することができる。
</div>
<div class="lm250 tm30 rm60">
イベントの種類とデリゲートメソッド名
</div>
<!-- 画像 -->
<a href="/lib/HTMLofImage.html?filename=/data/20/20_dragDrop2.png&title=ドラッグ＆ドロップ&width=800" target="_new">
<img class="lm110 tm0 bm0" src="20_dragDrop2.png" alt="[ドラッグ＆ドロップ]" width="530"></a>
<div class="lm70 tm30 rm60">
① ドラッグによりオブジェクトがビューに入る
</div>
<div class="lm70 tm0 rm60">
他のアプリケーションからドラッグされたオブジェクトが自身のビュー領域に入ったとき起動する。（戻り値を返すために必ず実行すること）
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/D_enter.txt" width="580" height="80"></iframe>
<div class="lm70 tm20 rm60">
② ドラッグによりオブジェクトがビューを移動中
</div>
<div class="lm70 tm0 rm60">
マウスの移動に伴いドラッグされたオブジェクトがビュー領域を移動しているときに連続的に起動する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/D_update.txt" width="580" height="80"></iframe>
<div class="lm70 tm20 rm60">
③ ドラッグによりオブジェクトがビューから出る
</div>
<div class="lm70 tm0 rm60">
ドラッグされたオブジェクトが自身のビュー領域から出たときに起動する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/D_exited.txt" width="580" height="80"></iframe>
<div class="lm70 tm20 rm60">
④ ドロップの準備
</div>
<div class="lm70 tm0 rm60">
ドロップ操作の直後、ドロップの実行の前に起動する。前処理があれば実装する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/D_prepare.txt" width="580" height="80"></iframe>
<div class="lm70 tm20 rm60">
⑤ ドロップの実行
</div>
<div class="lm70 tm5 rm60">
引数に、ドラッグされたオブジェクトを格納したペーストボードが渡るので、そこからイメージオブジェクトを読み込みビューに表示する。
</div>
<div class="lm70 tm10 rm60">
イメージにURLオブジェクトが附属していれば、URLアドレスをテキストビューに表示する。（カテゴリのデリゲートメソッドにより実装する）
</div>
<div class="lm70 tm10 rm60">
Finderのファイル名をドラッグされた場合、URLオブジェクトだけが読み込まれる。URLが画像ファイルであればイメージを読み込みビューに表示する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/D_drop.txt" width="580" height="850"></iframe>
<div class="lm70 tm20 rm60">
ビューの再描画（drawRectのオーバーライド）
</div>
<div class="lm70 tm0 rm60">
ビューに画像が収まるようをサイズの拡大/縮小を行う。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/D_drawRect.txt" width="580" height="380"></iframe>
<div class="lm70 tm20 rm60">
⑥ ドロップの完了
</div>
<div class="lm70 tm0 rm60">
ドロップ操作により起動する。ドロップの後処理があれば記述する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5 bm5" src="/lib/HTMLofText.html?filename=/data/20/D_conclude.txt" width="580" height="80"></iframe>
<!----------------------------------------------------------------------------->
<h3 class="lm70 tm30 bm0 rm60">
ドラッグの出発地の処理
</h3>
<h4 class="lm70 tm5 bm0 rm60">
表示中のイメージをドラッグし、別アプリケーションにドロップするまで
</h4>
<div class="lm70 tm0" style="width:550px; border-top:solid 1px #909090;"></div>

<div class="lm70 tm5 rm60">
本アプリケーションが保持するイメージを別アプリケーションにドラッグしドロップする。別アプリケーションがドラッグ＆ドロップの目的地になる処理を実装をしていれば、オブジェクトはその仕様に従って取り扱われる。
</div>
<div class="lm70 tm20 rm60">
① ビュー上のイメージをドラッグし、リッチテキストエディタ（テキストエディット）へドロップする。
</div>
<!-- 画像 -->
<a href="/lib/HTMLofImage.html?filename=/data/20/20_dragDrop13.png&title=コピー＆ペースト&width=800" target="_new">
<img class="lm110 tm0 bm0" src="20_dragDrop13.png" alt="[コピー＆ペースト]" width="450"></a>
<div class="lm70 tm20 rm60">
② ビュー上のイメージとURLオブジェクトをドラッグし、Finderの特定のディレクトリへペーストする。ファイルのコピーと同じ。
</div>
<!-- 画像 -->
<a href="/lib/HTMLofImage.html?filename=/data/20/20_dragDrop14.png&title=コピー＆ペースト&width=800" target="_new">
<img class="lm110 tm0 bm0" src="20_dragDrop14.png" alt="[コピー＆ペースト]" width="450"></a>
<H3 class="lm70 tm30 rm60 bm5">
アプリケーションの実装
</h3>
<div class="lm70 tm5 rm60">
ドラッグの出発地の処理は、NSViewクラスのサブクラスに実装し、NSDraggingSouceプロトコルに準拠しなくてはならない。インタフェース宣言でプロトコルの適用を宣言をする。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/S_interface.txt&font=font100" width="580" height="40"></iframe>

<div class="lm70 tm20 rm60">
(1) ドラッグセッションの開始
</div>
<div class="lm70 tm5 rm60">
mouseDownイベントのハンドラをオーバーライドする
</div>
<div class="lm70 tm0 rm60">
ドラッグするオブジェクトをNSDraggingItemオブジェクトに格納し、ドラッグセッションを開始する。ドラッグイメージ（ドラッグのカーソルの移動とともに表示する小さな画像）を作成する。ここではイメージのの縮小版を表示する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5" src="/lib/HTMLofText.html?filename=/data/20/S_begin.txt" width="580" height="650"></iframe>
<div class="lm70 tm30 rm60">
(2) デリゲートメソッドの実装
</div>
<div class="lm70 tm0 rm60">
ドラッグ＆ドロップ操作に対するデリゲートメソッドがあらかじめ定義されている。各メソッドをオーバーライドすることにより、ドラッグの出発地の処理を実装することができる。
</div>
<div class="lm70 tm10 rm60">
① オペレーションタイプの宣言
</div>
<div class="lm70 tm0 rm60">
ドラッグセッション開始時に起動する。オペレーションタイプは、NSDragOperationCopyを指定する。このメソッドは必ず実装すること。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5 bm10" src="/lib/HTMLofText.html?filename=/data/20/S_session.txt" width="580" height="90"></iframe>
<div class="lm70 tm20 rm60">
② ドラッグによりオブジェクトがビューを移動中
</div>
<div class="lm70 tm0 rm60">
マウスの移動に伴いドラッグされたオブジェクトがビュー領域を移動しているときに連続的に起動する。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5 bm10" src="/lib/HTMLofText.html?filename=/data/20/S_move.txt" width="580" height="90"></iframe>
<div class="lm70 tm20 rm60">
③ ドロップの完了
</div>
<div class="lm70 tm0 rm60">
ドロップの目的地のアプリでドロップ操作が完了したときに起動される。ドロップの後処理があれば記述する。例えば、オペレーションタイプがオブジェクトの移動（NSDragOperationMove）であった場合、出発地が保持しているオブジェクトの削除はここで行う。
</div>
<!-- ソースコード -->
<iframe class="lm70 tm5 bm10" src="/lib/HTMLofText.html?filename=/data/20/S_end.txt" width="580" height="110"></iframe>
<div class="lm70 tm20 rm40">
補足
</div>
<div class="lm70 tm0" style="width:530px; border-top:solid 1px #909090;"></div>
<div class="lm70 tm5 rm60">
本アプリは、ドラッグ＆ドロップの仕組みを説明するために、NSViewのカスタムクラスにプログラムを作成したものである。
</div>
<div class="lm70 tm10 rm60">
NSImageViewクラスやNSTextViewクラスには、あらかじめコピー＆ペーストやドラッグ＆ドロップの処理が組み込まれているので、本アプリで説明した処理を組み込む必要はない。（どのような処理が組み込まれているかはクラスによって異なる）
</div>
<h3 class="lm70 tm20 bm5 rm60">
ソースコード
</h3>
<div class="lm70 tm5 rm60">
<a href="/lib/HTMLofText.html?filename=/data/19/source/AppDelegate.txt&title=AppDelegate" target="_new">AppDelegateクラス</a>　コピー＆ペースト処理</div>	
<div class="lm70 tm0 rm60">
<a href="/lib/HTMLofText.html?filename=/data/19/source/CPView.txt&title=CPView" target="_new">
CPViewクラス</a>　コンテントビュー（コンテキストメニューを表示する）
</div>
<div class="lm70 tm0 rm60">
<a href="/lib/HTMLofText.html?filename=/data/19/source/UAView.txt&title=UAView" target="_new">
UAViewクラス</a>　イメージを表示するビュー（ドラッグ＆ドロップ機能）
</div>
<div class="lm70 tm0 rm60">
<a href="/lib/HTMLofText.html?filename=/data/19/source/NSViewUAViewDelegate.txt&title=NSView+UAViewDelegate" target="_new">
NSView+UAViewDelegate</a>　ドラッグ＆ドロップで使用するカテゴリ
</div>
<div class="bp40"></div><!-- 空白行 -->
<!----------------------------------------------->
</div><!-- end of content -->
<footer id="mainfooter">
<div class="tp10 bm10 bp10 textright"> 
<span class="rm500 font80"><a href="/lib/index1.html">メニューに戻る</a></span>
<span class="rm20 font80"><a href="#mainheader">TOPに戻る</a></span>
</div> 
</footer>
<script type="text/javascript" src="/lib/access/access2.js"></script>
</body>
</html>

